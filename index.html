<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Organizer Pro</title> <!-- Nombre ligeramente cambiado -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Estilos (iguales o con ajustes menores) -->
    <style>
        /* Estilos anteriores... */
        .tab-btn.active {
            border-bottom-width: 2px;
            border-color: #2563EB; /* blue-600 */
            color: #2563EB;
            font-weight: 600; /* Un poco más de énfasis */
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .selected-for-collage {
            ring: 4px;
            --tw-ring-color: #3B82F6;
            box-shadow: 0 0 0 4px var(--tw-ring-color);
            opacity: 0.8;
        }
        .photo-gallery-item {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .photo-gallery-item:hover {
            transform: scale(1.03);
            z-index: 10;
        }
        /* Añadido para Packing List */
        .packing-item-done label {
            text-decoration: line-through;
            color: #6b7280; /* gray-500 */
        }
         /* Estilos del toast */
         #toast {
            position: fixed;
            bottom: 1.25rem; /* bottom-5 */
            right: 1.25rem; /* right-5 */
            padding: 0.75rem 1.5rem; /* px-6 py-3 */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            color: white;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            max-width: 90%;
         }
         #toast.show {
             opacity: 1;
         }
         #toast.success { background-color: #10B981; } /* green-500 */
         #toast.error { background-color: #EF4444; } /* red-500 */
         #toast.info { background-color: #3B82F6; } /* blue-500 */
         #toast.warning { background-color: #F59E0B; } /* amber-500 */
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">
    <div class="container mx-auto px-4 py-8">
        <!-- Header (Sin cambios significativos) -->
        <header class="bg-gradient-to-r from-blue-600 to-indigo-800 text-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">Travel Organizer Pro</h1>
                    <p class="text-blue-200">Tu compañero de viaje perfecto</p>
                </div>
                <div class="relative">
                    <button id="notificationBtn" class="bg-white text-blue-600 p-3 rounded-full shadow-lg hover:bg-blue-100 transition">
                        <i class="fas fa-bell text-xl"></i>
                        <span id="notificationCount" class="notification-badge hidden">0</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content Tabs -->
        <div class="mb-8 bg-white rounded-lg shadow-sm">
             <div class="flex border-b border-gray-200 px-2">
                <button id="planTab" data-tab="planSection" class="tab-btn px-5 py-3 font-medium text-gray-600 hover:text-blue-600 transition duration-150 ease-in-out">
                    <i class="fas fa-edit mr-2"></i>Planificación
                </button>
                <button id="packingTab" data-tab="packingSection" class="tab-btn px-5 py-3 font-medium text-gray-600 hover:text-blue-600 transition duration-150 ease-in-out">
                    <i class="fas fa-suitcase-rolling mr-2"></i>Equipaje
                </button>
                <button id="travelTab" data-tab="travelSection" class="tab-btn px-5 py-3 font-medium text-gray-600 hover:text-blue-600 transition duration-150 ease-in-out">
                    <i class="fas fa-plane-departure mr-2"></i>Durante el Viaje
                </button>
                <button id="memoriesTab" data-tab="memoriesSection" class="tab-btn px-5 py-3 font-medium text-gray-600 hover:text-blue-600 transition duration-150 ease-in-out">
                    <i class="fas fa-images mr-2"></i>Recuerdos
                </button>
                 <button id="summaryTab" data-tab="summarySection" class="tab-btn px-5 py-3 font-medium text-gray-600 hover:text-blue-600 transition duration-150 ease-in-out">
                     <i class="fas fa-chart-pie mr-2"></i>Resumen
                 </button>
            </div>
        </div>

        <!-- Planificación Section -->
        <section id="planSection" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Columna 1: Datos Principales y Transporte -->
                <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Información del Viaje</h2>
                    <form id="travelForm" class="space-y-5">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="firstName" class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                                <input type="text" id="firstName" placeholder="Tu nombre" class="input-field">
                            </div>
                            <div>
                                <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1">Apellido</label>
                                <input type="text" id="lastName" placeholder="Tu apellido" class="input-field">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">Fecha de inicio</label>
                                <input type="date" id="startDate" class="input-field">
                            </div>
                            <div>
                                <label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">Fecha de fin</label>
                                <input type="date" id="endDate" class="input-field">
                            </div>
                        </div>
                         <div>
                            <label for="destination" class="block text-sm font-medium text-gray-700 mb-1">Destino Principal</label>
                            <input type="text" id="destination" placeholder="Ej: París, Francia" class="input-field">
                             <div class="mt-2 flex items-center gap-2">
                                <button type="button" id="searchDestination" class="btn btn-blue">
                                    <i class="fas fa-search mr-1"></i> Buscar Imagen
                                </button>
                                 <span id="imageSearchLoading" class="text-sm text-gray-500 hidden">Buscando... <i class="fas fa-spinner fa-spin"></i></span>
                                <!-- Sección de Previsión del Tiempo (Inicialmente Oculta) -->
                                <div id="weatherPreview" class="ml-auto text-sm text-gray-600 hidden flex items-center gap-2 p-2 bg-blue-50 rounded-lg">
                                    <i id="weatherIcon" class="fas text-xl text-blue-500"></i>
                                    <span id="weatherTemp"></span>
                                    <span id="weatherDesc" class="capitalize"></span>
                                </div>
                            </div>
                        </div>
                         <div id="destinationImageContainer" class="hidden mt-4">
                            <h3 class="text-base font-medium text-gray-600 mb-2">Imagen del destino:</h3>
                            <div class="relative group">
                                <img id="destinationImage" src="" alt="Imagen del destino" class="w-full h-48 object-cover rounded-lg shadow-md">
                                <button type="button" id="changeImage" title="Cambiar Imagen" class="absolute top-2 right-2 bg-white text-blue-600 p-2 rounded-full shadow opacity-0 group-hover:opacity-100 transition-opacity">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                         <hr class="my-4">
                         <h3 class="text-lg font-semibold text-gray-700 mb-3">Detalles del Transporte Principal</h3>
                         <div>
                            <label for="transportType" class="block text-sm font-medium text-gray-700 mb-1">Tipo de transporte</label>
                            <select id="transportType" class="input-field">
                                <option value="">Seleccionar...</option>
                                <option value="airplane">Avión</option>
                                <option value="train">Tren</option>
                                <option value="ship">Barco</option>
                                <option value="bus">Autobús</option>
                                <option value="car">Automóvil</option>
                                <option value="other">Otro</option>
                            </select>
                        </div>
                        <div id="transportDetails" class="hidden space-y-4 border border-gray-200 p-4 rounded-md bg-gray-50">
                            <div>
                                <label for="companyName" class="block text-sm font-medium text-gray-700 mb-1">Nombre Compañía / Detalles</label>
                                <input type="text" id="companyName" placeholder="Ej: Iberia, Renfe, Alquiler Coche XYZ" class="input-field bg-white">
                            </div>
                            <div>
                                <label for="ticketNumber" class="block text-sm font-medium text-gray-700 mb-1">Nº Boleto / Localizador / Matrícula</label>
                                <input type="text" id="ticketNumber" placeholder="Ej: ABCXYZ / EN54321 / 1234ABC" class="input-field bg-white">
                            </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="departureTime" class="block text-sm font-medium text-gray-700 mb-1">Hora de salida</label>
                                    <input type="time" id="departureTime" class="input-field bg-white">
                                </div>
                                <div>
                                    <label for="arrivalTime" class="block text-sm font-medium text-gray-700 mb-1">Hora de llegada (aprox)</label>
                                    <input type="time" id="arrivalTime" class="input-field bg-white">
                                </div>
                             </div>
                        </div>

                        <div class="pt-4">
                            <button type="submit" class="w-full btn btn-success text-lg">
                                <i class="fas fa-save mr-2"></i> Guardar Información del Viaje
                            </button>
                        </div>
                    </form>
                </div>
                <!-- Columna 2: Documentos y Presupuesto -->
                <div class="space-y-6">
                    <!-- Documentos Requeridos -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-file-alt mr-2 text-blue-500"></i>Documentos Esenciales</h2>
                        <div id="documentsRequiredList" class="space-y-3 mb-4">
                            <!-- Checkboxes como antes, pero con data-doc-name -->
                            <div class="flex items-center">
                                <input type="checkbox" id="passport" data-doc-name="Pasaporte" class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500 border-gray-300">
                                <label for="passport" class="ml-2 text-gray-700">Pasaporte</label>
                            </div>
                             <div class="flex items-center">
                                <input type="checkbox" id="idCard" data-doc-name="DNI / ID Nacional" class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500 border-gray-300">
                                <label for="idCard" class="ml-2 text-gray-700">DNI / ID Nacional</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="visa" data-doc-name="Visa(s)" class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500 border-gray-300">
                                <label for="visa" class="ml-2 text-gray-700">Visa(s)</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="vaccine" data-doc-name="Certificado Vacunas" class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500 border-gray-300">
                                <label for="vaccine" class="ml-2 text-gray-700">Certificado Vacunas</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="insurance" data-doc-name="Seguro de Viaje" class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500 border-gray-300">
                                <label for="insurance" class="ml-2 text-gray-700">Seguro de Viaje</label>
                            </div>
                             <div class="flex items-center">
                                <input type="checkbox" id="drivingLicense" data-doc-name="Carnet de Conducir" class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500 border-gray-300">
                                <label for="drivingLicense" class="ml-2 text-gray-700">Carnet de Conducir</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="otherDocsCheck" class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500 border-gray-300">
                                <label for="otherDocsCheck" class="ml-2 text-gray-700 flex-shrink-0">Otros:</label>
                                <input type="text" id="otherDocsText" placeholder="Especificar otros documentos" class="input-field ml-2 p-1 text-sm flex-grow">
                            </div>
                        </div>
                        <button id="saveDocsAndRemindersBtn" class="w-full btn btn-purple">
                            <i class="fas fa-check-double mr-2"></i> Guardar Documentos y Activar Recordatorios
                        </button>
                    </div>

                    <!-- Presupuesto Fijo -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                         <h2 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-dollar-sign mr-2 text-green-500"></i>Presupuesto Estimado</h2>
                         <form id="budgetForm" class="space-y-4">
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="ticketCost" class="block text-sm font-medium text-gray-700">Transporte Principal ($)</label>
                                    <input type="number" step="0.01" id="ticketCost" class="input-field" placeholder="0.00">
                                </div>
                                <div>
                                    <label for="accommodationCost" class="block text-sm font-medium text-gray-700">Alojamiento Total ($)</label>
                                    <input type="number" step="0.01" id="accommodationCost" class="input-field" placeholder="0.00">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="visaCost" class="block text-sm font-medium text-gray-700">Tasas / Visas ($)</label>
                                    <input type="number" step="0.01" id="visaCost" class="input-field" placeholder="0.00">
                                </div>
                                <div>
                                    <label for="activitiesBudget" class="block text-sm font-medium text-gray-700">Actividades/Tours ($)</label>
                                    <input type="number" step="0.01" id="activitiesBudget" class="input-field" placeholder="0.00">
                                </div>
                            </div>
                             <div>
                                <label for="dailyBudget" class="block text-sm font-medium text-gray-700">Presupuesto Diario (Comida, etc.) ($)</label>
                                <input type="number" step="0.01" id="dailyBudget" class="input-field" placeholder="0.00">
                            </div>
                            <button type="submit" class="w-full btn btn-orange">
                                <i class="fas fa-calculator mr-2"></i> Guardar Presupuesto
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Resumen de Gastos Variables (solo para planificación) -->
             <div class="mt-8 bg-white rounded-xl shadow-lg p-6">
                 <h2 class="text-2xl font-bold text-gray-800 mb-4"><i class="fas fa-cash-register mr-2 text-yellow-500"></i>Registro de Gastos (Opcional Pre-Viaje)</h2>
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                     <!-- Formulario para añadir gasto variable -->
                     <div class="lg:col-span-1 space-y-4">
                          <div>
                            <label for="expenseDescription" class="block text-sm font-medium text-gray-700">Añadir Gasto Pre-Viaje</label>
                            <input type="text" id="expenseDescription" placeholder="Descripción (ej: seguro extra, maleta)" class="input-field mt-1">
                         </div>
                          <div>
                             <label for="expenseAmount" class="block text-sm font-medium text-gray-700">Monto ($)</label>
                             <input type="number" step="0.01" id="expenseAmount" placeholder="0.00" class="input-field mt-1">
                         </div>
                         <div class="flex gap-2">
                            <button type="button" id="addExpenseBtn" class="btn btn-blue flex-grow">
                                <i class="fas fa-plus mr-1"></i> Añadir
                            </button>
                             <button id="addReceiptBtn" type="button" class="btn btn-purple" title="Añadir Recibo al Último Gasto">
                                <i class="fas fa-camera"></i>
                            </button>
                            <input type="file" id="receiptInput" accept="image/*" capture="environment" class="hidden">
                         </div>
                     </div>
                     <!-- Tabla de gastos variables -->
                     <div class="lg:col-span-2 overflow-x-auto">
                         <h3 class="text-lg font-semibold text-gray-700 mb-2">Gastos Registrados Antes del Viaje</h3>
                         <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="th-table">Descripción</th>
                                    <th class="th-table">Monto</th>
                                    <th class="th-table">Fecha</th>
                                    <th class="th-table">Recibo</th>
                                    <th class="th-table">Acción</th>
                                </tr>
                            </thead>
                            <tbody id="expensesTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Filas dinámicas -->
                                <tr><td colspan="5" class="td-table text-center text-gray-500">No hay gastos pre-viaje registrados.</td></tr>
                            </tbody>
                        </table>
                     </div>
                 </div>
             </div>
        </section>

        <!-- Packing List Section -->
        <section id="packingSection" class="tab-content">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex justify-between items-center">
                    <span><i class="fas fa-suitcase-rolling mr-2 text-blue-500"></i>Lista de Equipaje</span>
                    <button id="addPackingCategoryBtn" class="btn btn-sm btn-purple">
                        <i class="fas fa-plus mr-1"></i> Nueva Categoría
                    </button>
                </h2>

                <div id="packingListContainer" class="space-y-6">
                    <!-- Las categorías y elementos se añadirán aquí -->
                    <p id="noPackingItems" class="text-gray-500">Empieza añadiendo categorías (ej: Ropa, Electrónicos, Aseo) y luego elementos a cada una.</p>
                </div>
                 <!-- Template para nueva categoría -->
                 <div id="packingCategoryTemplate" class="hidden">
                     <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 packing-category">
                         <div class="flex justify-between items-center mb-3">
                             <input type="text" class="text-lg font-semibold text-gray-700 bg-transparent border-b border-gray-300 focus:outline-none focus:border-blue-500 category-title-input" placeholder="Nombre de Categoría">
                             <div>
                                <button class="btn btn-xs btn-green save-category-btn"><i class="fas fa-check"></i></button>
                                <button class="btn btn-xs btn-red remove-category-btn ml-1"><i class="fas fa-trash-alt"></i></button>
                             </div>
                         </div>
                         <ul class="space-y-2 packing-item-list">
                             <!-- Elementos de la lista -->
                         </ul>
                         <div class="mt-3 flex gap-2">
                             <input type="text" class="input-field p-1 text-sm flex-grow new-item-input" placeholder="Añadir elemento...">
                             <button class="btn btn-sm btn-blue add-item-btn"><i class="fas fa-plus"></i> Añadir</button>
                         </div>
                     </div>
                 </div>
                 <!-- Template para elemento de lista -->
                 <li id="packingItemTemplate" class="hidden flex items-center justify-between packing-item">
                    <div class="flex items-center">
                        <input type="checkbox" class="h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500 item-checkbox">
                        <label class="ml-3 text-gray-800 item-label"></label>
                    </div>
                    <button class="btn btn-xs btn-red remove-item-btn"><i class="fas fa-times"></i></button>
                 </li>
            </div>
        </section>

        <!-- Durante el Viaje Section -->
        <section id="travelSection" class="tab-content">
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Itinerario -->
                <div class="bg-white rounded-xl shadow-lg p-6 lg:col-span-2">
                    <div class="flex justify-between items-center mb-6 border-b pb-2">
                        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-map-signs mr-2 text-indigo-500"></i>Itinerario</h2>
                         <button id="addActivityBtn" class="btn btn-blue">
                            <i class="fas fa-plus mr-1"></i> Añadir Actividad
                        </button>
                    </div>
                    <div id="itineraryContainer" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                        <!-- Se llenará dinámicamente -->
                        <p class="text-gray-500">No hay actividades planeadas aún.</p>
                    </div>
                </div>

                <!-- Documentos Rápidos y Gastos Diarios -->
                <div class="space-y-6">
                    <!-- Checklist Rápido Documentos -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-check-circle mr-2 text-green-500"></i>Checklist Rápido</h2>
                        <div id="documentsChecklist" class="space-y-3 max-h-40 overflow-y-auto pr-1 mb-3">
                             <p class="text-gray-500 text-sm">Configura documentos en Planificación.</p>
                        </div>
                        <button id="showDocumentsStatusBtn" class="w-full btn btn-sm btn-outline-blue">
                            Ver Estado Detallado de Documentos
                        </button>
                    </div>

                    <!-- Registro de Gastos Diarios -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-wallet mr-2 text-orange-500"></i>Gastos del Día</h2>
                         <div class="mt-4 mb-4 p-3 rounded-lg bg-gradient-to-r from-blue-50 to-indigo-50 flex justify-around text-center">
                            <div>
                                <p class="text-sm text-blue-700">Presupuesto Diario</p>
                                <p id="dailyBudgetDisplay" class="font-bold text-lg text-blue-800">$0.00</p>
                            </div>
                            <div>
                                <p class="text-sm text-green-700">Gastado Hoy</p>
                                <p id="dailyExpensesDisplay" class="font-bold text-lg text-green-800">$0.00</p>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label for="dailyExpenseAmount" class="block text-sm font-medium text-gray-700">Añadir Gasto ($)</label>
                                <input type="number" step="0.01" id="dailyExpenseAmount" placeholder="0.00" class="input-field mt-1">
                            </div>
                             <div>
                                <label for="dailyExpenseDescription" class="block text-sm font-medium text-gray-700">Descripción</label>
                                <input type="text" id="dailyExpenseDescription" placeholder="Ej: Café, Taxi al museo" class="input-field mt-1">
                            </div>
                            <div>
                                 <label for="expenseCategory" class="block text-sm font-medium text-gray-700">Categoría</label>
                                 <select id="expenseCategory" class="input-field mt-1">
                                    <option value="food">Comida</option>
                                    <option value="transport">Transporte</option>
                                    <option value="activities">Actividades</option>
                                    <option value="shopping">Compras</option>
                                    <option value="accommodation">Alojamiento</option>
                                    <option value="other">Otros</option>
                                </select>
                            </div>
                             <div class="flex gap-2">
                                <button id="addDailyExpenseBtn" class="btn btn-blue flex-grow">
                                    <i class="fas fa-plus mr-1"></i> Registrar Gasto
                                </button>
                                <button id="addTravelReceiptBtn" type="button" class="btn btn-purple" title="Añadir Recibo al Último Gasto Diario">
                                    <i class="fas fa-camera"></i>
                                </button>
                                <input type="file" id="travelReceiptInput" accept="image/*" capture="environment" class="hidden">
                           </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historial Gastos Diarios -->
            <div class="mt-8 bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4"><i class="fas fa-history mr-2 text-teal-500"></i>Historial de Gastos Diarios</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="th-table">Fecha</th>
                                <th class="th-table">Desc.</th>
                                <th class="th-table">Categoría</th>
                                <th class="th-table">Monto</th>
                                <th class="th-table">Recibo</th>
                                <th class="th-table">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="dailyExpensesTableBody" class="bg-white divide-y divide-gray-200">
                             <tr><td colspan="6" class="td-table text-center text-gray-500">No hay gastos diarios registrados.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Recuerdos Section -->
        <section id="memoriesSection" class="tab-content">
             <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                 <h2 class="text-2xl font-bold text-gray-800 mb-6"><i class="fas fa-images mr-2 text-pink-500"></i>Galería y Collages</h2>
                 <div class="mb-6 flex flex-wrap gap-4 items-center">
                     <label for="memoryPhotoInput" class="btn btn-teal cursor-pointer">
                         <i class="fas fa-upload mr-2"></i> Cargar Fotos
                     </label>
                    <input type="file" id="memoryPhotoInput" accept="image/*,.heic,.heif" multiple class="hidden"> <!-- Accept HEIC/HEIF -->
                    <span id="photoUploadStatus" class="text-sm text-gray-500"></span>
                    <button id="toggleSelectModeBtn" class="btn btn-outline-blue ml-auto hidden">
                        <i class="fas fa-check-square mr-1"></i> Seleccionar para Collage
                    </button>
                 </div>

                <div id="photoGallery" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-6 min-h-[120px] border border-dashed border-gray-300 p-4 rounded-lg">
                     <p id="noPhotosMessage" class="text-gray-500 col-span-full text-center py-4">Aún no has cargado fotos.</p>
                     <!-- Template para foto en galería -->
                     <div id="photoTemplate" class="hidden relative photo-gallery-item group rounded-lg overflow-hidden shadow-sm border-2 border-transparent">
                        <img src="" alt="Foto de viaje" class="w-full h-40 sm:h-48 object-cover">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-40 transition-all duration-300 flex items-center justify-center">
                            <!-- Iconos de acción que aparecen al pasar el ratón -->
                            <button class="delete-photo-btn absolute bottom-2 right-2 bg-white text-red-600 p-1.5 rounded-full shadow hover:bg-red-100 transition opacity-0 group-hover:opacity-100" title="Eliminar Foto">
                                <i class="fas fa-trash-alt text-sm pointer-events-none"></i>
                            </button>
                            <!-- Checkmark para selección de collage -->
                            <div class="absolute top-2 left-2 bg-blue-600 text-white w-6 h-6 rounded-full shadow checkmark hidden items-center justify-center" title="Seleccionada">
                                <i class="fas fa-check text-xs"></i>
                            </div>
                        </div>
                     </div>
                </div>

                <!-- Área de Creación de Collage (oculta inicialmente) -->
                <div id="collageCreationArea" class="hidden mt-6 border-t pt-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Crear Collage</h3>
                     <p class="text-gray-600 mb-4 text-sm">Haz clic en las fotos de arriba para seleccionarlas (<span id="selectedPhotoCount">0</span> seleccionadas, mínimo 3). Luego haz clic en "Crear Collage".</p>
                    <button id="createCollageBtn" class="btn btn-blue mb-6" disabled>
                        <i class="fas fa-magic mr-2"></i> Crear Collage con Fotos Seleccionadas
                    </button>

                    <div id="collagePreviewContainer" class="hidden relative bg-gray-100 rounded-lg p-4 min-h-64 mb-6 border border-dashed border-gray-400">
                        <div class="flex justify-between items-center mb-2">
                             <h4 class="text-lg font-medium text-gray-600">Vista Previa</h4>
                             <button id="cancelCollageBtn" class="btn btn-xs btn-red" title="Cancelar Creación">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="collageGrid" class="grid grid-cols-3 gap-1 aspect-square max-w-md mx-auto bg-white p-1 shadow"></div>
                        <button id="saveCollageBtn" class="mt-4 block mx-auto btn btn-success">
                            <i class="fas fa-save mr-2"></i> Guardar Collage
                        </button>
                    </div>
                </div>

                <!-- Collages Guardados -->
                <div id="savedCollages" class="mt-8 border-t pt-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Mis Collages</h3>
                    <div id="collageGallery" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <p id="noCollagesMessage" class="text-gray-500 col-span-full">No has guardado ningún collage.</p>
                         <!-- Template para collage guardado -->
                        <div id="savedCollageTemplate" class="hidden relative photo-gallery-item group border rounded-lg overflow-hidden shadow-md">
                            <img src="" alt="Collage de viaje" class="w-full h-48 object-cover">
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-40 transition-all duration-300 flex items-center justify-center opacity-0 group-hover:opacity-100">
                                <button class="view-collage-btn btn btn-sm bg-white text-blue-600" title="Ver Collage">
                                    <i class="fas fa-expand-alt"></i>
                                </button>
                                <button class="delete-collage-btn btn btn-sm bg-white text-red-600 ml-2" title="Eliminar Collage">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                            <p class="absolute bottom-1 left-2 text-xs text-white bg-black bg-opacity-50 px-1 rounded collage-date"></p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

         <!-- Resumen Section -->
        <section id="summarySection" class="tab-content">
             <div class="bg-white rounded-xl shadow-lg p-6">
                 <h2 class="text-2xl font-bold text-gray-800 mb-6"><i class="fas fa-briefcase mr-2 text-purple-500"></i>Resumen del Viaje</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Detalles y Estadísticas -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-1">Detalles Clave</h3>
                        <div id="tripSummaryDetails" class="space-y-2 text-gray-700 mb-6 text-sm">
                            <p class="text-gray-500">Completa la sección de Planificación.</p>
                        </div>

                         <h3 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-1">Estadísticas Rápidas</h3>
                         <div class="space-y-2 text-sm">
                             <p><strong><i class="fas fa-calendar-alt mr-1 text-blue-500"></i> Duración:</strong> <span id="summaryDuration">N/A</span></p>
                             <p><strong><i class="fas fa-tasks mr-1 text-green-500"></i> Actividades Completadas:</strong> <span id="summaryActivitiesCompleted">0 / 0</span></p>
                             <p><strong><i class="fas fa-camera-retro mr-1 text-pink-500"></i> Fotos Cargadas:</strong> <span id="summaryPhotosCount">0</span></p>
                             <p><strong><i class="fas fa-th mr-1 text-teal-500"></i> Collages Creados:</strong> <span id="summaryCollagesCount">0</span></p>
                         </div>
                    </div>
                    <!-- Resumen Financiero y Gráfico -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-1">Resumen Financiero Total</h3>
                        <div class="space-y-3 text-sm mb-6">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Presupuesto Fijo Estimado:</span>
                                <span id="summaryTotalBudget" class="font-medium text-gray-800">$0.00</span>
                            </div>
                             <div class="flex justify-between">
                                <span class="text-gray-600">Gasto Variable (Pre-Viaje):</span>
                                <span id="summaryVariableExpenses" class="font-medium text-gray-800">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Gasto Diario (Durante Viaje):</span>
                                <span id="summaryDailyExpenses" class="font-medium text-gray-800">$0.00</span>
                            </div>
                             <div class="flex justify-between font-bold border-t border-gray-300 pt-2 mt-1">
                                <span class="text-gray-900">Gasto Total Registrado:</span>
                                <span id="summaryGrandTotal" class="text-lg text-red-600">$0.00</span>
                            </div>
                        </div>
                         <h3 class="text-lg font-semibold text-gray-700 mb-2">Distribución del Gasto Total</h3>
                         <div class="h-64 relative"> <!-- Contenedor con altura fija -->
                            <canvas id="summaryChart"></canvas>
                            <p id="summaryChartPlaceholder" class="absolute inset-0 flex items-center justify-center text-gray-400 text-center hidden">No hay datos financieros suficientes para el gráfico.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </div> <!-- Fin container -->

    <!-- Modales (sin cambios estructurales significativos, solo IDs ajustados si es necesario) -->
    <!-- Modal Notificaciones -->
    <div id="notificationModal" class="modal-overlay hidden"> <div class="modal-content max-w-md"> ... (contenido modal notificaciones) ... </div> </div>
    <!-- Modal Actividad -->
    <div id="activityModal" class="modal-overlay hidden"> <div class="modal-content max-w-md"> ... (contenido modal actividad) ... </div> </div>
    <!-- Modal Estado Documentos -->
    <div id="documentsModal" class="modal-overlay hidden"> <div class="modal-content max-w-2xl"> ... (contenido modal documentos) ... </div> </div>
    <!-- Modal Recibo/Imagen -->
    <div id="receiptModal" class="modal-overlay hidden"> <div class="modal-content max-w-lg"> ... (contenido modal recibo) ... </div> </div>

    <!-- Toast Notification Placeholder -->
    <div id="toast">
        <span id="toastMessage"></span>
    </div>

    <!-- Scripts -->
    <script>
        // --- Configuración ---
        const UNSPLASH_API_KEY = 'NBBWQ9HR0Ve7VxR-9c1su8bTDUrC3af7cQ11Gmk8dhc'; // ¡¡¡ REEMPLAZAR !!!
        const OPENWEATHER_API_KEY = '39a90f57f681781f6557a37756d66237'; // ¡¡¡ REEMPLAZAR !!!

        // --- Estado Global ---
        let travelData = {
            // ... (estructura como en la versión anterior, pero añadiendo packingList)
            packingList: [], // Array de categorías { id, name, items: [{id, name, done}] }
             // ... resto de la estructura ...
             personalInfo: {}, tripDetails: {}, budget: {}, documents: [], expenses: [], activities: [], dailyExpenses: {}, memories: { photos: [], collages: [] }, notifications: []
        };
        let activeTab = 'planSection'; // Pestaña activa inicial
        let expensesChart = null;
        let summaryChart = null;
        let selectedPhotosForCollage = [];
        let lastAddedExpenseId = null;
        let lastAddedDailyExpenseId = null;
        let isSelectModeActive = false; // Para la selección de fotos del collage

        // --- DOM Elements ---
        // (Obtener todos los elementos necesarios por ID, similar a la versión anterior)
        // ... (añadir IDs para nuevos elementos como packing list, weather, etc.)
        const tabs = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const packingListContainer = document.getElementById('packingListContainer');
        const addPackingCategoryBtn = document.getElementById('addPackingCategoryBtn');
        const noPackingItems = document.getElementById('noPackingItems');
        const weatherPreview = document.getElementById('weatherPreview');
        const weatherIcon = document.getElementById('weatherIcon');
        const weatherTemp = document.getElementById('weatherTemp');
        const weatherDesc = document.getElementById('weatherDesc');
        // ... otros elementos ...
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');

        // Templates (Clonaremos estos para crear nuevos elementos)
        const packingCategoryTemplate = document.getElementById('packingCategoryTemplate');
        const packingItemTemplate = document.getElementById('packingItemTemplate');
        const photoTemplate = document.getElementById('photoTemplate'); // Template para fotos en galería
        const savedCollageTemplate = document.getElementById('savedCollageTemplate'); // Template para collages guardados
        const summaryChartPlaceholder = document.getElementById('summaryChartPlaceholder');

        // --- Inicialización ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Cargado. Inicializando App...");
            // Simplificar obtención de elementos comunes
             addCommonElementSelectors();

            loadData();
            setupTabs();
            setupEventListeners(); // Centralizar listeners
            updateUI();
             // Activar la pestaña inicial guardada o la primera
             const initialTab = localStorage.getItem('activeTravelTab') || 'planSection';
             activateTab(initialTab);
             console.log("App Inicializada.");
        });

        function addCommonElementSelectors() {
            // Asignar elementos del DOM a variables globales aquí para evitar repetición
            // Ejemplo:
             window.el = { // Usar un objeto global simple (o una clase si prefieres)
                firstName: document.getElementById('firstName'),
                lastName: document.getElementById('lastName'),
                startDate: document.getElementById('startDate'),
                endDate: document.getElementById('endDate'),
                destination: document.getElementById('destination'),
                searchDestination: document.getElementById('searchDestination'),
                imageSearchLoading: document.getElementById('imageSearchLoading'),
                destinationImageContainer: document.getElementById('destinationImageContainer'),
                destinationImage: document.getElementById('destinationImage'),
                changeImage: document.getElementById('changeImage'),
                transportType: document.getElementById('transportType'),
                transportDetails: document.getElementById('transportDetails'),
                companyName: document.getElementById('companyName'),
                ticketNumber: document.getElementById('ticketNumber'),
                departureTime: document.getElementById('departureTime'),
                arrivalTime: document.getElementById('arrivalTime'),
                travelForm: document.getElementById('travelForm'),
                // ... y así sucesivamente para todos los elementos usados frecuentemente
                budgetForm: document.getElementById('budgetForm'),
                ticketCost: document.getElementById('ticketCost'),
                accommodationCost: document.getElementById('accommodationCost'),
                visaCost: document.getElementById('visaCost'),
                activitiesBudget: document.getElementById('activitiesBudget'), // Nuevo presupuesto actividades
                dailyBudget: document.getElementById('dailyBudget'),
                documentsRequiredList: document.getElementById('documentsRequiredList'),
                saveDocsAndRemindersBtn: document.getElementById('saveDocsAndRemindersBtn'),
                expenseDescription: document.getElementById('expenseDescription'),
                expenseAmount: document.getElementById('expenseAmount'),
                addExpenseBtn: document.getElementById('addExpenseBtn'),
                addReceiptBtn: document.getElementById('addReceiptBtn'),
                receiptInput: document.getElementById('receiptInput'),
                expensesTableBody: document.getElementById('expensesTableBody'),
                // Durante Viaje
                itineraryContainer: document.getElementById('itineraryContainer'),
                addActivityBtn: document.getElementById('addActivityBtn'),
                documentsChecklist: document.getElementById('documentsChecklist'),
                showDocumentsStatusBtn: document.getElementById('showDocumentsStatusBtn'),
                dailyBudgetDisplay: document.getElementById('dailyBudgetDisplay'),
                dailyExpensesDisplay: document.getElementById('dailyExpensesDisplay'),
                dailyExpenseAmount: document.getElementById('dailyExpenseAmount'),
                dailyExpenseDescription: document.getElementById('dailyExpenseDescription'),
                expenseCategory: document.getElementById('expenseCategory'),
                addDailyExpenseBtn: document.getElementById('addDailyExpenseBtn'),
                addTravelReceiptBtn: document.getElementById('addTravelReceiptBtn'),
                travelReceiptInput: document.getElementById('travelReceiptInput'),
                dailyExpensesTableBody: document.getElementById('dailyExpensesTableBody'),
                 // Recuerdos
                 memoryPhotoInput: document.getElementById('memoryPhotoInput'),
                 photoUploadStatus: document.getElementById('photoUploadStatus'),
                 photoGallery: document.getElementById('photoGallery'),
                 noPhotosMessage: document.getElementById('noPhotosMessage'),
                 toggleSelectModeBtn: document.getElementById('toggleSelectModeBtn'),
                 collageCreationArea: document.getElementById('collageCreationArea'),
                 createCollageBtn: document.getElementById('createCollageBtn'),
                 selectedPhotoCount: document.getElementById('selectedPhotoCount'),
                 collagePreviewContainer: document.getElementById('collagePreviewContainer'),
                 collageGrid: document.getElementById('collageGrid'),
                 cancelCollageBtn: document.getElementById('cancelCollageBtn'),
                 saveCollageBtn: document.getElementById('saveCollageBtn'),
                 savedCollages: document.getElementById('savedCollages'),
                 collageGallery: document.getElementById('collageGallery'),
                 noCollagesMessage: document.getElementById('noCollagesMessage'),
                 // Resumen
                 tripSummaryDetails: document.getElementById('tripSummaryDetails'),
                 summaryDuration: document.getElementById('summaryDuration'),
                 summaryActivitiesCompleted: document.getElementById('summaryActivitiesCompleted'),
                 summaryPhotosCount: document.getElementById('summaryPhotosCount'),
                 summaryCollagesCount: document.getElementById('summaryCollagesCount'),
                 summaryTotalBudget: document.getElementById('summaryTotalBudget'),
                 summaryVariableExpenses: document.getElementById('summaryVariableExpenses'), // Nuevo para separar
                 summaryDailyExpenses: document.getElementById('summaryDailyExpenses'),       // Nuevo para separar
                 summaryGrandTotal: document.getElementById('summaryGrandTotal'),
                 summaryChartCtx: document.getElementById('summaryChart')?.getContext('2d'), // Obtener contexto directamente
                 // Modales y Notificaciones
                 notificationBtn: document.getElementById('notificationBtn'),
                 notificationCount: document.getElementById('notificationCount'),
                 notificationModal: document.getElementById('notificationModal'),
                 closeNotificationModal: document.getElementById('closeNotificationModal'),
                 notificationList: document.getElementById('notificationList'),
                 activityModal: document.getElementById('activityModal'),
                 activityForm: document.getElementById('activityForm'),
                 activityModalTitle: document.getElementById('activityModalTitle'),
                 closeActivityModal: document.getElementById('closeActivityModal'),
                 documentsModal: document.getElementById('documentsModal'),
                 closeDocumentsModal: document.getElementById('closeDocumentsModal'),
                 documentsList: document.getElementById('documentsList'),
                 receiptModal: document.getElementById('receiptModal'),
                 modalReceiptImage: document.getElementById('modalReceiptImage'),
                 closeReceiptModal: document.getElementById('closeReceiptModal'),
            };
        }

        // --- Persistencia ---
        function saveData() {
            try {
                localStorage.setItem('travelData', JSON.stringify(travelData));
                console.log("Datos guardados:", travelData);
            } catch (error) {
                console.error("Error guardando datos:", error);
                showToast("Error al guardar datos. Espacio lleno?", 'error');
            }
        }

        function loadData() {
            const savedData = localStorage.getItem('travelData');
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    // Merge parsed data with default structure to ensure all keys exist
                    travelData = {
                         personalInfo: {}, tripDetails: {}, budget: {}, documents: [], expenses: [], activities: [], dailyExpenses: {},
                         packingList: [], // Asegurar que packingList exista
                         memories: { photos: [], collages: [] }, notifications: [],
                        ...parsedData // Sobrescribir con datos guardados
                    };
                     // Asegurar sub-estructuras si no existen en datos guardados antiguos
                     travelData.memories = travelData.memories || { photos: [], collages: [] };
                     travelData.budget = travelData.budget || {};
                     travelData.dailyExpenses = travelData.dailyExpenses || {};
                     travelData.packingList = travelData.packingList || [];

                    console.log("Datos cargados:", travelData);
                } catch (error) {
                    console.error("Error parseando datos guardados:", error);
                     resetData(); // Resetear si hay error de parseo
                }
            } else {
                 console.log("No hay datos guardados, usando estado inicial.");
                 // Opcional: inicializar con datos de ejemplo si se desea
                 // travelData.packingList = [ { id: Date.now(), name: "Ropa", items: [] } ];
            }
        }

        function resetData() {
             if (confirm("¿Estás seguro de que quieres borrar TODOS los datos de este viaje y empezar de nuevo? Esta acción no se puede deshacer.")) {
                 travelData = { personalInfo: {}, tripDetails: {}, budget: {}, documents: [], expenses: [], activities: [], dailyExpenses: {}, packingList: [], memories: { photos: [], collages: [] }, notifications: [] };
                 localStorage.removeItem('travelData');
                 localStorage.removeItem('activeTravelTab'); // Limpiar pestaña activa
                 updateUI();
                 activateTab('planSection'); // Volver a la primera pestaña
                 showToast("Datos del viaje borrados.", 'info');
             }
         }

        // --- Toast Notifications ---
        function showToast(message, type = 'info', duration = 3000) {
            toastMessage.textContent = message;
            toast.className = 'show'; // Quitar clases previas y añadir 'show'
            toast.classList.add(type); // Añadir clase de tipo (success, error, etc.)

            setTimeout(() => {
                 toast.className = ''; // Limpiar clases para ocultar con transición
            }, duration);
        }

        // --- Tabs ---
        function setupTabs() {
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                     const targetTabId = tab.dataset.tab;
                     activateTab(targetTabId);
                });
            });
        }

        function activateTab(tabId) {
            tabs.forEach(t => {
                t.classList.remove('active', 'text-blue-600', 'border-blue-600', 'font-semibold');
                t.classList.add('text-gray-600', 'font-medium');
                 if (t.dataset.tab === tabId) {
                     t.classList.add('active', 'text-blue-600', 'border-blue-600', 'font-semibold');
                     t.classList.remove('text-gray-600', 'font-medium');
                 }
            });
            tabContents.forEach(content => {
                content.classList.toggle('active', content.id === tabId);
                content.classList.toggle('hidden', content.id !== tabId);
            });
            activeTab = tabId;
             localStorage.setItem('activeTravelTab', tabId); // Guardar pestaña activa
             // Opcional: Cargar datos específicos de la pestaña si es necesario
             if (tabId === 'summarySection') {
                 updateTripSummary(); // Asegurarse de que el resumen esté actualizado al verlo
             }
              if (tabId === 'packingSection') {
                 renderPackingList(); // Asegurarse de que la lista de equipaje esté actualizada
             }
        }

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            // Formularios
            el.travelForm.addEventListener('submit', handleTravelFormSubmit);
            el.budgetForm.addEventListener('submit', handleBudgetFormSubmit);
            el.activityForm.addEventListener('submit', handleActivityFormSubmit);

            // Botones Planificación
            el.searchDestination.addEventListener('click', handleSearchDestination);
            el.changeImage.addEventListener('click', handleChangeDestinationImage);
            el.transportType.addEventListener('change', handleTransportTypeChange);
            el.saveDocsAndRemindersBtn.addEventListener('click', handleSaveDocsAndReminders);
            el.addExpenseBtn.addEventListener('click', handleAddVariableExpense);
            el.addReceiptBtn.addEventListener('click', () => el.receiptInput.click());
            el.receiptInput.addEventListener('change', handleVariableReceiptUpload);
            el.expensesTableBody.addEventListener('click', handleExpensesTableClick); // Delegación para Delete/View

            // Botones Equipaje
            addPackingCategoryBtn.addEventListener('click', handleAddPackingCategory);
            packingListContainer.addEventListener('click', handlePackingListClick); // Delegación eventos lista

            // Botones Durante Viaje
            el.addActivityBtn.addEventListener('click', openAddActivityModal);
            el.itineraryContainer.addEventListener('click', handleItineraryClick); // Delegación Edit/Complete/Delete
            el.showDocumentsStatusBtn.addEventListener('click', openDocumentsModal);
            el.addDailyExpenseBtn.addEventListener('click', handleAddDailyExpense);
            el.addTravelReceiptBtn.addEventListener('click', () => el.travelReceiptInput.click());
            el.travelReceiptInput.addEventListener('change', handleDailyReceiptUpload);
            el.dailyExpensesTableBody.addEventListener('click', handleDailyExpensesTableClick); // Delegación Delete/View

            // Botones Recuerdos
            el.memoryPhotoInput.addEventListener('change', handleMemoryPhotoUpload);
             el.photoGallery.addEventListener('click', handlePhotoGalleryClick); // Delegación Delete/Select
             el.toggleSelectModeBtn.addEventListener('click', toggleSelectMode); // Botón explícito
            el.createCollageBtn.addEventListener('click', handleCreateCollagePreview);
            el.cancelCollageBtn.addEventListener('click', handleCancelCollagePreview);
            el.saveCollageBtn.addEventListener('click', handleSaveCollage);
            el.collageGallery.addEventListener('click', handleCollageGalleryClick); // Delegación View/Delete

            // Modales y Notificaciones
            el.notificationBtn.addEventListener('click', openNotificationModal);
            el.closeNotificationModal.addEventListener('click', closeNotificationModal);
            el.notificationList.addEventListener('click', handleNotificationListClick);
            el.closeActivityModal.addEventListener('click', closeActivityModal);
            el.closeDocumentsModal.addEventListener('click', closeDocumentsModal);
            el.closeReceiptModal.addEventListener('click', closeReceiptModal);
            // Añadir listener para el botón de reset si se implementa
        }

        // --- Handlers (Funciones que responden a eventos) ---

        function handleTravelFormSubmit(e) {
            e.preventDefault();
            travelData.personalInfo = { firstName: el.firstName.value.trim(), lastName: el.lastName.value.trim() };
            travelData.tripDetails = {
                ...travelData.tripDetails, // Preservar imagen
                startDate: el.startDate.value,
                endDate: el.endDate.value,
                destination: el.destination.value.trim(),
                transportType: el.transportType.value,
                companyName: el.companyName.value.trim(),
                ticketNumber: el.ticketNumber.value.trim(),
                departureTime: el.departureTime.value,
                arrivalTime: el.arrivalTime.value
            };
            saveData();
             updateTripSummary(); // Actualizar resumen por si acaso
             showToast("Información del viaje guardada.", 'success');
             // Intentar obtener el tiempo si hay destino y fecha
             if (travelData.tripDetails.destination && travelData.tripDetails.startDate) {
                 getWeather(travelData.tripDetails.destination, travelData.tripDetails.startDate);
             }
        }

        function handleBudgetFormSubmit(e) {
            e.preventDefault();
             travelData.budget = {
                 ticketCost: parseFloat(el.ticketCost.value) || 0,
                 accommodationCost: parseFloat(el.accommodationCost.value) || 0,
                 visaCost: parseFloat(el.visaCost.value) || 0,
                 activitiesBudget: parseFloat(el.activitiesBudget.value) || 0, // Añadido
                 dailyBudget: parseFloat(el.dailyBudget.value) || 0
             };
            saveData();
             updateBudgetSummary(); // Actualizar solo resúmenes de presupuesto
             updateTripSummary();   // y el resumen general
             updateDailyBudgetDisplay(); // Actualizar display en "Durante Viaje"
             showToast("Presupuesto guardado.", 'success');
        }

        async function handleSearchDestination() {
            const searchTerm = el.destination.value.trim();
            if (!searchTerm) return showToast('Ingresa un destino para buscar imagen.', 'warning');
            if (!UNSPLASH_API_KEY || UNSPLASH_API_KEY === 'YOUR_UNSPLASH_ACCESS_KEY') {
                showToast('Clave API de Unsplash no configurada.', 'error');
                console.error("Unsplash API Key missing.");
                el.destinationImage.src = 'https://via.placeholder.com/600x400.png?text=Configura+API+Key';
                el.destinationImageContainer.classList.remove('hidden');
                return;
            }

            el.imageSearchLoading.classList.remove('hidden');
            el.searchDestination.disabled = true;
            weatherPreview.classList.add('hidden'); // Ocultar tiempo mientras busca imagen

            try {
                const url = `https://api.unsplash.com/search/photos?query=${encodeURIComponent(searchTerm)}&per_page=1&orientation=landscape&client_id=${UNSPLASH_API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();

                if (response.ok && data.results?.length > 0) {
                    const imageUrl = data.results[0].urls.regular;
                    el.destinationImage.src = imageUrl;
                    el.destinationImageContainer.classList.remove('hidden');
                    travelData.tripDetails.destinationImage = imageUrl;
                    saveData();
                    showToast("Imagen encontrada.", 'success');
                    // Ahora buscar tiempo si hay fecha
                    if (travelData.tripDetails.startDate) {
                         getWeather(searchTerm, travelData.tripDetails.startDate);
                    }
                } else {
                    showToast(`No se encontraron imágenes para "${searchTerm}".`, 'info');
                    el.destinationImage.src = `https://via.placeholder.com/600x400.png?text=${encodeURIComponent(searchTerm)}`;
                    el.destinationImageContainer.classList.remove('hidden');
                    travelData.tripDetails.destinationImage = '';
                    saveData();
                }
            } catch (error) {
                console.error('Error Unsplash:', error);
                showToast('Error al buscar imagen.', 'error');
                el.destinationImage.src = 'https://via.placeholder.com/600x400.png?text=Error+de+Red';
                el.destinationImageContainer.classList.remove('hidden');
                travelData.tripDetails.destinationImage = '';
                saveData();
            } finally {
                el.imageSearchLoading.classList.add('hidden');
                el.searchDestination.disabled = false;
            }
        }

        function handleChangeDestinationImage() {
            el.destinationImageContainer.classList.add('hidden');
            el.destinationImage.src = '';
            travelData.tripDetails.destinationImage = '';
             weatherPreview.classList.add('hidden'); // Ocultar tiempo si se quita imagen
            saveData();
            showToast("Imagen eliminada. Puedes buscar otra.", 'info');
        }

        function handleTransportTypeChange() {
            el.transportDetails.classList.toggle('hidden', !el.transportType.value);
        }

        function handleSaveDocsAndReminders() {
             const selectedDocs = [];
             const checkboxes = el.documentsRequiredList.querySelectorAll('input[type="checkbox"]');
             checkboxes.forEach(checkbox => {
                 if (checkbox.checked) {
                     if (checkbox.id === 'otherDocsCheck') {
                         const otherText = document.getElementById('otherDocsText').value.trim();
                         if (otherText) selectedDocs.push(otherText);
                     } else if (checkbox.dataset.docName) {
                         selectedDocs.push(checkbox.dataset.docName);
                     }
                 }
             });
             travelData.documents = selectedDocs;
             createDocumentReminders(selectedDocs); // Intenta crear notificaciones/recordatorios
             saveData();
             updateDocumentsChecklist(); // Actualizar checklist en "Durante Viaje"
             showToast(`Documentos guardados (${selectedDocs.length}). Recordatorios creados (si aplica).`, 'success');
        }

        function handleAddVariableExpense() {
             const description = el.expenseDescription.value.trim();
             const amount = parseFloat(el.expenseAmount.value);
             if (!description || isNaN(amount) || amount <= 0) {
                 return showToast('Ingresa descripción y monto válido.', 'warning');
             }
             const expense = { id: Date.now(), description, amount, date: new Date().toLocaleDateString('en-CA'), receipt: null };
             travelData.expenses.push(expense);
             lastAddedExpenseId = expense.id;
             updateExpensesUI();
             updateBudgetSummary(); // Afecta al resumen de presupuesto
             updateTripSummary();   // y al general
             saveData();
             showToast(`Gasto "${description}" agregado.`, 'success');
             el.expenseDescription.value = '';
             el.expenseAmount.value = '';
             lastAddedDailyExpenseId = null; // Resetear ID diario por si acaso
        }

        function handleVariableReceiptUpload(e) {
            handleReceiptUpload(e.target.files[0], lastAddedExpenseId, 'expense');
            el.receiptInput.value = ''; // Reset input
        }

        function handleExpensesTableClick(e) {
            const deleteBtn = e.target.closest('.delete-expense-btn');
            const viewBtn = e.target.closest('.view-receipt-btn');
            if (deleteBtn) {
                const expenseId = parseInt(deleteBtn.dataset.id);
                if (confirm('¿Eliminar este gasto variable?')) {
                    travelData.expenses = travelData.expenses.filter(exp => exp.id !== expenseId);
                    updateExpensesUI(); updateBudgetSummary(); updateTripSummary(); saveData();
                    showToast('Gasto variable eliminado.', 'success');
                }
            } else if (viewBtn) {
                const expenseId = parseInt(viewBtn.dataset.id);
                showReceipt(expenseId, 'expense');
            }
        }

         function handleAddPackingCategory() {
             const newCategory = { id: Date.now(), name: "", items: [] };
             travelData.packingList.push(newCategory);
             renderPackingList(); // Re-render para incluir la nueva categoría editable
             // Enfocar el input del título de la nueva categoría
             const newCategoryElement = packingListContainer.querySelector(`.packing-category[data-category-id="${newCategory.id}"]`);
             newCategoryElement?.querySelector('.category-title-input')?.focus();
             saveData(); // Guardar la estructura inicial de la categoría
         }

        function handlePackingListClick(e) {
            const categoryElement = e.target.closest('.packing-category');
            if (!categoryElement) return;
            const categoryId = parseInt(categoryElement.dataset.categoryId);

            // Guardar título de categoría
            if (e.target.classList.contains('save-category-btn') || e.target.closest('.save-category-btn')) {
                 const titleInput = categoryElement.querySelector('.category-title-input');
                 const newName = titleInput.value.trim();
                 if (newName) {
                     const category = travelData.packingList.find(c => c.id === categoryId);
                     if (category) {
                         category.name = newName;
                         titleInput.blur(); // Quitar foco
                         showToast(`Categoría "${newName}" guardada.`, 'success');
                         saveData();
                         // Opcional: renderizar de nuevo solo esta categoría si cambia la apariencia
                     }
                 } else {
                     showToast('El nombre de la categoría no puede estar vacío.', 'warning');
                 }
            }
            // Eliminar categoría
            else if (e.target.classList.contains('remove-category-btn') || e.target.closest('.remove-category-btn')) {
                if (confirm('¿Eliminar esta categoría y todos sus elementos?')) {
                    travelData.packingList = travelData.packingList.filter(c => c.id !== categoryId);
                    renderPackingList();
                    saveData();
                    showToast('Categoría eliminada.', 'success');
                }
            }
            // Añadir elemento
            else if (e.target.classList.contains('add-item-btn') || e.target.closest('.add-item-btn')) {
                const itemInput = categoryElement.querySelector('.new-item-input');
                const itemName = itemInput.value.trim();
                if (itemName) {
                     const category = travelData.packingList.find(c => c.id === categoryId);
                     if (category) {
                         const newItem = { id: Date.now(), name: itemName, done: false };
                         category.items.push(newItem);
                         renderPackingListCategory(category, categoryElement); // Re-render solo esta categoría
                         itemInput.value = '';
                         itemInput.focus();
                         saveData();
                     }
                }
            }
             // Marcar/Desmarcar elemento
            else if (e.target.classList.contains('item-checkbox')) {
                 const itemElement = e.target.closest('.packing-item');
                 const itemId = parseInt(itemElement.dataset.itemId);
                 const category = travelData.packingList.find(c => c.id === categoryId);
                 const item = category?.items.find(i => i.id === itemId);
                 if (item) {
                     item.done = e.target.checked;
                     itemElement.classList.toggle('packing-item-done', item.done);
                     saveData();
                 }
             }
             // Eliminar elemento
             else if (e.target.classList.contains('remove-item-btn') || e.target.closest('.remove-item-btn')) {
                 const itemElement = e.target.closest('.packing-item');
                 const itemId = parseInt(itemElement.dataset.itemId);
                 const category = travelData.packingList.find(c => c.id === categoryId);
                 if (category) {
                     category.items = category.items.filter(i => i.id !== itemId);
                     renderPackingListCategory(category, categoryElement); // Re-render solo esta categoría
                     saveData();
                 }
             }
        }

        function openAddActivityModal() {
            el.activityForm.reset();
            document.getElementById('activityId').value = ''; // Asegurar que no haya ID
            el.activityModalTitle.textContent = 'Agregar Actividad';
            el.activityModal.classList.remove('hidden');
        }

        function handleActivityFormSubmit(e) {
             e.preventDefault();
             const activityId = document.getElementById('activityId').value;
             const activityData = {
                 date: document.getElementById('activityDate').value,
                 time: document.getElementById('activityTime').value,
                 title: document.getElementById('activityTitle').value.trim(),
                 description: document.getElementById('activityDescription').value.trim(),
                 location: document.getElementById('activityLocation').value.trim(),
                 completed: false // Default
             };
             if (!activityData.date || !activityData.time || !activityData.title) {
                 return showToast("Completa Fecha, Hora y Título de la actividad.", 'warning');
             }

             if (activityId) { // Editando
                 const index = travelData.activities.findIndex(a => a.id === parseInt(activityId));
                 if (index > -1) {
                     activityData.id = parseInt(activityId);
                     activityData.completed = travelData.activities[index].completed; // Preservar estado
                     travelData.activities[index] = activityData;
                     showToast("Actividad actualizada.", 'success');
                 }
             } else { // Nuevo
                 activityData.id = Date.now();
                 travelData.activities.push(activityData);
                 showToast("Actividad agregada.", 'success');
                 addNotification('Actividad Agendada', `${activityData.title} - ${formatDisplayDate(activityData.date)}`, 'info');
             }
             updateActivitiesUI(); updateTripSummary(); saveData();
             el.activityModal.classList.add('hidden');
        }

        function handleItineraryClick(e) {
            const completeBtn = e.target.closest('.complete-activity-btn');
            const deleteBtn = e.target.closest('.delete-activity-btn');
            const editBtn = e.target.closest('.edit-activity-btn');
            if (completeBtn) {
                const activityId = parseInt(completeBtn.dataset.id);
                const activity = travelData.activities.find(a => a.id === activityId);
                if (activity) { activity.completed = !activity.completed; updateActivitiesUI(); updateTripSummary(); saveData(); }
            } else if (deleteBtn) {
                const activityId = parseInt(deleteBtn.dataset.id);
                if (confirm('¿Eliminar esta actividad?')) {
                    travelData.activities = travelData.activities.filter(a => a.id !== activityId);
                    updateActivitiesUI(); updateTripSummary(); saveData();
                    showToast('Actividad eliminada.', 'success');
                }
            } else if (editBtn) {
                const activityId = parseInt(editBtn.dataset.id);
                const activity = travelData.activities.find(a => a.id === activityId);
                if (activity) { // Poblar y abrir modal para editar
                    document.getElementById('activityId').value = activity.id;
                    document.getElementById('activityDate').value = activity.date;
                    document.getElementById('activityTime').value = activity.time;
                    document.getElementById('activityTitle').value = activity.title;
                    document.getElementById('activityDescription').value = activity.description;
                    document.getElementById('activityLocation').value = activity.location;
                    el.activityModalTitle.textContent = 'Editar Actividad';
                    el.activityModal.classList.remove('hidden');
                }
            }
        }

        function openDocumentsModal() {
            updateDocumentsList(); // Actualizar lista antes de mostrar
            el.documentsModal.classList.remove('hidden');
        }

        function handleAddDailyExpense() {
            const amount = parseFloat(el.dailyExpenseAmount.value);
            const description = el.dailyExpenseDescription.value.trim();
            const category = el.expenseCategory.value;
            if (isNaN(amount) || amount <= 0 || !description) {
                return showToast('Ingresa monto y descripción válidos.', 'warning');
            }
            const today = new Date().toLocaleDateString('en-CA');
            if (!travelData.dailyExpenses[today]) travelData.dailyExpenses[today] = [];
            const dailyExpense = { id: Date.now(), description, category, amount, receipt: null };
            travelData.dailyExpenses[today].push(dailyExpense);
            lastAddedDailyExpenseId = dailyExpense.id;
            updateDailyExpensesUI(); updateTripSummary(); saveData();
            showToast(`Gasto diario (${getCategoryName(category)}) registrado.`, 'success');
            el.dailyExpenseAmount.value = ''; el.dailyExpenseDescription.value = '';
            lastAddedExpenseId = null; // Resetear ID variable
        }

        function handleDailyReceiptUpload(e) {
            handleReceiptUpload(e.target.files[0], lastAddedDailyExpenseId, 'daily');
            el.travelReceiptInput.value = ''; // Reset input
        }

         function handleDailyExpensesTableClick(e) {
            const deleteBtn = e.target.closest('.delete-daily-expense-btn');
            const viewBtn = e.target.closest('.view-receipt-btn');
            if (deleteBtn) {
                const expenseId = parseInt(deleteBtn.dataset.id);
                const expenseDate = deleteBtn.dataset.date;
                if (confirm('¿Eliminar este gasto diario?')) {
                    if (travelData.dailyExpenses[expenseDate]) {
                        travelData.dailyExpenses[expenseDate] = travelData.dailyExpenses[expenseDate].filter(exp => exp.id !== expenseId);
                        if (travelData.dailyExpenses[expenseDate].length === 0) delete travelData.dailyExpenses[expenseDate];
                        updateDailyExpensesUI(); updateTripSummary(); saveData();
                        showToast('Gasto diario eliminado.', 'success');
                    }
                }
            } else if (viewBtn) {
                const expenseId = parseInt(viewBtn.dataset.id);
                showReceipt(expenseId, 'daily');
            }
        }

        function handleMemoryPhotoUpload(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;
            el.photoUploadStatus.textContent = `Cargando ${files.length} foto(s)...`;
            let loadedCount = 0;
            if (!travelData.memories.photos) travelData.memories.photos = [];

            const processFile = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        // Simple check for image type (can be improved)
                        if (event.target.result.startsWith('data:image/')) {
                            travelData.memories.photos.push({
                                id: Date.now() + Math.random(), // More unique ID
                                src: event.target.result,
                                name: file.name
                            });
                        } else {
                             console.warn(`Archivo ${file.name} no parece ser una imagen, omitido.`);
                             // Opcional: notificar al usuario
                             // showToast(`Archivo ${file.name} omitido (no es imagen).`, 'warning');
                        }
                        resolve();
                    };
                    reader.onerror = (error) => {
                        console.error("Error leyendo archivo:", file.name, error);
                        reject(error);
                    };
                    reader.readAsDataURL(file);
                });
            };

             // Procesar todos los archivos en paralelo
             Promise.all(Array.from(files).map(processFile))
                 .catch(err => showToast("Hubo errores al cargar algunas fotos.", "warning"))
                 .finally(() => {
                     updateMemoriesGallery();
                     saveData();
                     const finalCount = travelData.memories.photos.length - (travelData.memories.photos.length - loadedCount); // Count added
                     el.photoUploadStatus.textContent = `${finalCount} foto(s) cargada(s).`;
                     showToast(`${finalCount} foto(s) agregada(s) a la galería.`, 'success');
                     setTimeout(() => el.photoUploadStatus.textContent = '', 3000);
                 });

            el.memoryPhotoInput.value = ''; // Reset input
        }

        function handlePhotoGalleryClick(e) {
            const photoElement = e.target.closest('.photo-gallery-item');
            if (!photoElement) return;
            const photoId = parseFloat(photoElement.dataset.photoId); // Usar el ID guardado
            const photoSrc = photoElement.querySelector('img')?.src; // Usar la fuente real

            const deleteBtn = e.target.closest('.delete-photo-btn');

             if (deleteBtn) { // Acción de eliminar siempre disponible
                 if (confirm('¿Eliminar esta foto de la galería?')) {
                     travelData.memories.photos = travelData.memories.photos.filter(p => p.id !== photoId);
                     // También quitarla de la selección de collage si estaba
                     selectedPhotosForCollage = selectedPhotosForCollage.filter(src => src !== photoSrc);
                     updateMemoriesGallery();
                     updateCollageButtonState();
                     saveData();
                     showToast('Foto eliminada.', 'success');
                 }
            } else if (isSelectModeActive) { // Acción de seleccionar solo si el modo está activo
                const checkmark = photoElement.querySelector('.checkmark');
                const index = selectedPhotosForCollage.indexOf(photoSrc);
                if (index > -1) { // Deseleccionar
                    selectedPhotosForCollage.splice(index, 1);
                    photoElement.classList.remove('selected-for-collage');
                    checkmark.classList.add('hidden');
                } else { // Seleccionar
                    selectedPhotosForCollage.push(photoSrc);
                    photoElement.classList.add('selected-for-collage');
                    checkmark.classList.remove('hidden');
                }
                updateCollageButtonState();
             } else {
                 // Acción por defecto al hacer clic si no está en modo selección (ej: ver en grande)
                 if (photoSrc) {
                    showImageModal(photoSrc, "Foto de Viaje");
                 }
             }
        }

         function toggleSelectMode() {
             isSelectModeActive = !isSelectModeActive;
             el.photoGallery.classList.toggle('select-mode-active', isSelectModeActive); // Clase para estilos opcionales
             el.toggleSelectModeBtn.innerHTML = isSelectModeActive
                 ? '<i class="fas fa-times mr-1"></i> Terminar Selección'
                 : '<i class="fas fa-check-square mr-1"></i> Seleccionar para Collage';
             el.toggleSelectModeBtn.classList.toggle('btn-outline-blue', !isSelectModeActive);
             el.toggleSelectModeBtn.classList.toggle('btn-red', isSelectModeActive); // Cambiar a rojo para cancelar

             if (!isSelectModeActive) {
                 // Limpiar selección visual al salir del modo
                 selectedPhotosForCollage = [];
                 document.querySelectorAll('.photo-gallery-item.selected-for-collage').forEach(el => {
                     el.classList.remove('selected-for-collage');
                     el.querySelector('.checkmark').classList.add('hidden');
                 });
                 updateCollageButtonState();
                 el.collagePreviewContainer.classList.add('hidden'); // Ocultar preview si estaba visible
             }
         }

        function handleCreateCollagePreview() {
            if (selectedPhotosForCollage.length < 3) return;
            el.collageGrid.innerHTML = ''; // Limpiar
            el.collagePreviewContainer.classList.remove('hidden');
            // Layout simple basado en número de fotos (mejorable)
            let gridClass = 'grid-cols-3'; // Default 3x3 max
             if (selectedPhotosForCollage.length === 4) gridClass = 'grid-cols-2 grid-rows-2';
             else if (selectedPhotosForCollage.length === 3) gridClass = 'grid-cols-3 grid-rows-1'; // O 1 arriba 2 abajo?

             // Limit to max 9 photos for preview
             const photosToDisplay = selectedPhotosForCollage.slice(0, 9);

            el.collageGrid.className = `grid ${gridClass} gap-1 aspect-square max-w-md mx-auto bg-white p-1 shadow`; // Aplicar clase

            photosToDisplay.forEach(src => {
                const img = document.createElement('img');
                img.src = src;
                img.className = 'w-full h-full object-cover';
                img.alt = 'Foto para collage';
                el.collageGrid.appendChild(img);
            });
            el.collagePreviewContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function handleCancelCollagePreview() {
            el.collagePreviewContainer.classList.add('hidden');
            el.collageGrid.innerHTML = '';
        }

        function handleSaveCollage() {
            if (selectedPhotosForCollage.length < 3 || el.collageGrid.children.length === 0) {
                return showToast('Selecciona al menos 3 fotos y previsualiza.', 'warning');
            }
            el.saveCollageBtn.disabled = true;
            el.saveCollageBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Guardando...';

            html2canvas(el.collageGrid, { scale: 2, useCORS: true })
                .then(canvas => {
                    const collageData = canvas.toDataURL('image/jpeg', 0.9);
                    const memory = { id: Date.now(), type: 'collage', date: new Date().toLocaleDateString('en-CA'), data: collageData };
                    if (!travelData.memories.collages) travelData.memories.collages = [];
                    travelData.memories.collages.push(memory);
                    saveData();
                    updateSavedCollages();
                    showToast('Collage guardado.', 'success');
                    // Resetear selección y salir del modo selección si estaba activo
                    selectedPhotosForCollage = [];
                    document.querySelectorAll('.photo-gallery-item.selected-for-collage').forEach(el => {
                        el.classList.remove('selected-for-collage');
                        el.querySelector('.checkmark').classList.add('hidden');
                    });
                     if(isSelectModeActive) toggleSelectMode(); // Salir del modo selección
                    updateCollageButtonState();
                    handleCancelCollagePreview(); // Ocultar preview
                })
                .catch(error => { console.error("html2canvas error:", error); showToast('Error al crear imagen del collage.', 'error'); })
                .finally(() => {
                    el.saveCollageBtn.disabled = false;
                    el.saveCollageBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Guardar Collage';
                });
        }

        function handleCollageGalleryClick(e) {
            const viewBtn = e.target.closest('.view-collage-btn');
            const deleteBtn = e.target.closest('.delete-collage-btn');
            const collageElement = e.target.closest('.photo-gallery-item');
            if (!collageElement) return;
            const collageId = parseFloat(collageElement.dataset.collageId); // Usar ID del collage guardado

            if (viewBtn) {
                const collage = travelData.memories.collages.find(c => c.id === collageId);
                if (collage) showImageModal(collage.data, `Collage - ${formatDisplayDate(collage.date)}`);
            } else if (deleteBtn) {
                if (confirm('¿Eliminar este collage guardado?')) {
                    travelData.memories.collages = travelData.memories.collages.filter(c => c.id !== collageId);
                    updateSavedCollages(); updateTripSummary(); saveData();
                    showToast('Collage eliminado.', 'success');
                }
            }
        }

        // --- Notificaciones Modal ---
        function openNotificationModal() {
            updateNotificationList();
            el.notificationModal.classList.remove('hidden');
            // Opcional: Marcar como leídas al abrir
             travelData.notifications.forEach(n => n.read = true);
             updateNotificationCount(); // Poner contador a 0 visualmente
             saveData(); // Guardar el estado de lectura
        }
        function closeNotificationModal() { el.notificationModal.classList.add('hidden'); }

        function handleNotificationListClick(e) {
            const deleteBtn = e.target.closest('.delete-notification-btn');
            const notificationDiv = e.target.closest('[data-id]');
            if (!notificationDiv) return;
            const notificationId = parseInt(notificationDiv.dataset.id);

            if (deleteBtn) {
                travelData.notifications = travelData.notifications.filter(n => n.id !== notificationId);
                updateNotificationList(); updateNotificationCount(); saveData();
            }
            // No hay botón "mark-read" porque se marcan al abrir el modal
        }

        // --- Otros Modales ---
        function closeActivityModal() { el.activityModal.classList.add('hidden'); }
        function closeDocumentsModal() { el.documentsModal.classList.add('hidden'); }
        function closeReceiptModal() { el.receiptModal.classList.add('hidden'); el.modalReceiptImage.src = ''; }

        // --- Funciones de Actualización de UI (Renderizado) ---

        function updateUI() {
            console.log("Actualizando UI completa...");
             // Formularios Planificación
             el.firstName.value = travelData.personalInfo.firstName || '';
             el.lastName.value = travelData.personalInfo.lastName || '';
             el.startDate.value = travelData.tripDetails.startDate || '';
             el.endDate.value = travelData.tripDetails.endDate || '';
             el.destination.value = travelData.tripDetails.destination || '';
             el.transportType.value = travelData.tripDetails.transportType || '';
             el.companyName.value = travelData.tripDetails.companyName || '';
             el.ticketNumber.value = travelData.tripDetails.ticketNumber || '';
             el.departureTime.value = travelData.tripDetails.departureTime || '';
             el.arrivalTime.value = travelData.tripDetails.arrivalTime || '';
             el.transportDetails.classList.toggle('hidden', !el.transportType.value);

             // Imagen Destino y Tiempo
             if (travelData.tripDetails.destinationImage) {
                el.destinationImage.src = travelData.tripDetails.destinationImage;
                el.destinationImageContainer.classList.remove('hidden');
             } else {
                el.destinationImageContainer.classList.add('hidden');
             }
             // Refrescar tiempo si hay datos
             if (travelData.tripDetails.destination && travelData.tripDetails.startDate) {
                 getWeather(travelData.tripDetails.destination, travelData.tripDetails.startDate);
             } else {
                  weatherPreview.classList.add('hidden');
             }

            // Presupuesto
             el.ticketCost.value = travelData.budget.ticketCost || '';
             el.accommodationCost.value = travelData.budget.accommodationCost || '';
             el.visaCost.value = travelData.budget.visaCost || '';
             el.activitiesBudget.value = travelData.budget.activitiesBudget || '';
             el.dailyBudget.value = travelData.budget.dailyBudget || '';

            // Documentos
            updateDocumentsRequiredChecklist();
            updateDocumentsChecklist(); // Durante Viaje (checklist rápido)

            // Gastos Variables Planificación
            updateExpensesUI();

            // Presupuesto y Resumen (se llama desde otros updates si es necesario)
             updateBudgetSummary();
             updateDailyBudgetDisplay();

            // Itinerario
            updateActivitiesUI();

            // Gastos Diarios
            updateDailyExpensesUI();

             // Lista de Equipaje (renderizar si existe el contenedor)
             if (packingListContainer) renderPackingList();

            // Recuerdos
            updateMemoriesGallery();
            updateSavedCollages();
             el.toggleSelectModeBtn.classList.toggle('hidden', travelData.memories.photos.length === 0); // Ocultar botón si no hay fotos


            // Resumen Final (se actualiza al cambiar de pestaña o datos relevantes)
             if (activeTab === 'summarySection') {
                 updateTripSummary();
             }

            // Notificaciones
            updateNotificationCount();
        }

        function updateDocumentsRequiredChecklist() {
             const checkboxes = el.documentsRequiredList.querySelectorAll('input[type="checkbox"]');
             checkboxes.forEach(checkbox => {
                 const docName = checkbox.dataset.docName;
                 if (checkbox.id === 'otherDocsCheck') {
                    const otherDoc = travelData.documents.find(d => ![/*lista docs estándar*/].includes(d));
                    checkbox.checked = !!otherDoc;
                    document.getElementById('otherDocsText').value = otherDoc || '';
                 } else if (docName) {
                     checkbox.checked = travelData.documents.includes(docName);
                 }
             });
         }

         function updateDocumentsChecklist() { // Durante Viaje (checklist rápido)
             el.documentsChecklist.innerHTML = ''; // Limpiar
             if (!travelData.documents || travelData.documents.length === 0) {
                 el.documentsChecklist.innerHTML = '<p class="text-gray-500 text-sm">Configura documentos en Planificación.</p>';
                 return;
             }
             travelData.documents.forEach(doc => {
                 const docId = `travel_doc_${doc.replace(/\s+/g, '_').toLowerCase()}`;
                 const div = document.createElement('div');
                 div.className = 'flex items-center';
                 // Estos checkboxes son solo visuales para el usuario durante el viaje
                 div.innerHTML = `
                    <input type="checkbox" id="${docId}" class="h-4 w-4 text-green-600 rounded border-gray-300 focus:ring-green-500">
                    <label for="${docId}" class="ml-2 text-sm text-gray-700">${doc}</label>
                 `;
                 el.documentsChecklist.appendChild(div);
             });
         }

        function updateExpensesUI() { // Gastos Variables (Planificación)
            el.expensesTableBody.innerHTML = '';
            if (!travelData.expenses || travelData.expenses.length === 0) {
                el.expensesTableBody.innerHTML = '<tr><td colspan="5" class="td-table text-center text-gray-500">No hay gastos pre-viaje registrados.</td></tr>';
                return;
            }
             // Ordenar por fecha (más reciente primero) si se desea
             // const sortedExpenses = [...travelData.expenses].sort((a, b) => new Date(b.date) - new Date(a.date));
             travelData.expenses.forEach(expense => { // Usar travelData.expenses directamente si no se ordena
                 const row = document.createElement('tr');
                 row.className = 'hover:bg-gray-50';
                 row.innerHTML = `
                    <td class="td-table">${expense.description}</td>
                    <td class="td-table text-right pr-4">${formatCurrency(expense.amount)}</td>
                    <td class="td-table">${formatDisplayDate(expense.date)}</td>
                    <td class="td-table text-center">
                        ${expense.receipt ? `<button class="icon-btn-blue view-receipt-btn" data-type="expense" data-id="${expense.id}"><i class="fas fa-receipt"></i></button>` : '<span class="text-gray-400 text-xs">No</span>'}
                    </td>
                    <td class="td-table text-center">
                         <button class="icon-btn-red delete-expense-btn" data-id="${expense.id}"><i class="fas fa-trash-alt"></i></button>
                    </td>
                `;
                 el.expensesTableBody.appendChild(row);
             });
        }

        function updateBudgetSummary() { // Actualiza los displays de presupuesto en Planificación
             const budget = travelData.budget || {};
             // Esta función ahora solo actualiza los displays relacionados al presupuesto base
             // El cálculo total se hace en updateTripSummary
         }
         function updateDailyBudgetDisplay() { // Actualiza display en Durante Viaje
             el.dailyBudgetDisplay.textContent = formatCurrency(travelData.budget.dailyBudget || 0);
         }

        function updateActivitiesUI() {
            el.itineraryContainer.innerHTML = '';
            if (!travelData.activities || travelData.activities.length === 0) {
                el.itineraryContainer.innerHTML = '<p class="text-gray-500">No hay actividades planeadas aún.</p>';
                return;
            }
            const sortedActivities = [...travelData.activities].sort((a, b) => {
                const dtA = new Date(`${a.date}T${a.time || '00:00'}`);
                const dtB = new Date(`${b.date}T${b.time || '00:00'}`);
                return dtA - dtB;
            });

            let currentDay = null;
            sortedActivities.forEach(activity => {
                const activityDate = new Date(`${activity.date}T00:00:00`);
                const dayStr = activityDate.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

                if (dayStr !== currentDay) {
                    currentDay = dayStr;
                    const dayHeader = document.createElement('h3');
                    dayHeader.className = 'text-lg font-semibold text-indigo-700 mt-4 mb-2 border-b pb-1';
                    dayHeader.textContent = currentDay;
                    el.itineraryContainer.appendChild(dayHeader);
                }

                const div = document.createElement('div');
                div.className = `p-4 rounded-lg border flex justify-between items-start gap-4 ${activity.completed ? 'bg-green-50 border-green-200 opacity-70' : 'bg-gray-50 border-gray-200'}`;
                div.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-medium text-gray-800">${activity.time ? formatTime(activity.time) : ''} - ${activity.title}</p>
                        ${activity.location ? `<p class="text-xs text-gray-600 mt-1"><i class="fas fa-map-marker-alt text-red-500 mr-1"></i> ${activity.location}</p>` : ''}
                        ${activity.description ? `<p class="mt-1 text-sm text-gray-700">${activity.description}</p>` : ''}
                    </div>
                    <div class="flex flex-col sm:flex-row items-center gap-1 flex-shrink-0">
                         <button class="icon-btn-blue edit-activity-btn" data-id="${activity.id}"><i class="fas fa-pencil-alt"></i></button>
                        <button class="complete-activity-btn ${activity.completed ? 'text-green-600 hover:text-green-700' : 'text-gray-400 hover:text-gray-600'}" data-id="${activity.id}">
                            <i class="fas ${activity.completed ? 'fa-check-circle' : 'fa-circle'} text-xl"></i>
                        </button>
                        <button class="icon-btn-red delete-activity-btn" data-id="${activity.id}"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                el.itineraryContainer.appendChild(div);
            });
        }

        function updateDailyExpensesUI() { // Historial en Durante Viaje y Resumen Diario
            el.dailyExpensesTableBody.innerHTML = '';
            const today = new Date().toLocaleDateString('en-CA');
            let todayTotal = 0;
            const allDailyExpenses = [];

             Object.keys(travelData.dailyExpenses || {}).forEach(dateKey => {
                 travelData.dailyExpenses[dateKey].forEach(expense => {
                     allDailyExpenses.push({ ...expense, date: dateKey });
                     if (dateKey === today) todayTotal += expense.amount;
                 });
             });

            allDailyExpenses.sort((a, b) => { // Más reciente primero
                const dateComp = b.date.localeCompare(a.date);
                return dateComp !== 0 ? dateComp : b.id - a.id;
            });

             if (allDailyExpenses.length === 0) {
                 el.dailyExpensesTableBody.innerHTML = '<tr><td colspan="6" class="td-table text-center text-gray-500">No hay gastos diarios registrados.</td></tr>';
             } else {
                 allDailyExpenses.forEach(expense => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="td-table">${formatDisplayDate(expense.date)}</td>
                        <td class="td-table">${expense.description}</td>
                        <td class="td-table"><span class="badge ${getCategoryBadge(expense.category)}">${getCategoryName(expense.category)}</span></td>
                        <td class="td-table text-right pr-4 font-medium">${formatCurrency(expense.amount)}</td>
                        <td class="td-table text-center">
                            ${expense.receipt ? `<button class="icon-btn-blue view-receipt-btn" data-type="daily" data-id="${expense.id}"><i class="fas fa-receipt"></i></button>` : '<span class="text-gray-400 text-xs">No</span>'}
                        </td>
                        <td class="td-table text-center">
                            <button class="icon-btn-red delete-daily-expense-btn" data-date="${expense.date}" data-id="${expense.id}"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    `;
                    el.dailyExpensesTableBody.appendChild(row);
                });
             }
            el.dailyExpensesDisplay.textContent = formatCurrency(todayTotal);
        }

        function renderPackingList() {
             packingListContainer.innerHTML = ''; // Limpiar
             if (!travelData.packingList || travelData.packingList.length === 0) {
                 noPackingItems.classList.remove('hidden');
                 return;
             }
             noPackingItems.classList.add('hidden');

             travelData.packingList.forEach(category => {
                 const categoryDiv = renderPackingListCategory(category);
                 packingListContainer.appendChild(categoryDiv);
             });
         }

        function renderPackingListCategory(category, existingElement = null) {
            const categoryElement = existingElement || packingCategoryTemplate.content.firstElementChild.cloneNode(true);
            categoryElement.dataset.categoryId = category.id;

            const titleInput = categoryElement.querySelector('.category-title-input');
            const itemList = categoryElement.querySelector('.packing-item-list');
            const newItemInput = categoryElement.querySelector('.new-item-input');

             titleInput.value = category.name || '';
             itemList.innerHTML = ''; // Limpiar lista de items

            category.items.forEach(item => {
                const itemElement = packingItemTemplate.content.firstElementChild.cloneNode(true);
                itemElement.dataset.itemId = item.id;
                const checkbox = itemElement.querySelector('.item-checkbox');
                const label = itemElement.querySelector('.item-label');
                checkbox.checked = item.done;
                label.textContent = item.name;
                itemElement.classList.toggle('packing-item-done', item.done);
                itemList.appendChild(itemElement);
            });

             newItemInput.value = ''; // Limpiar input de nuevo item

            return categoryElement; // Devolver el elemento por si no existía
        }


         function updateMemoriesGallery() {
             el.photoGallery.innerHTML = ''; // Limpiar siempre
             selectedPhotosForCollage = []; // Resetear selección al re-renderizar
             isSelectModeActive = false; // Resetear modo selección
             el.photoGallery.classList.remove('select-mode-active');
             el.toggleSelectModeBtn.innerHTML = '<i class="fas fa-check-square mr-1"></i> Seleccionar para Collage';
             el.toggleSelectModeBtn.className = 'btn btn-outline-blue ml-auto'; // Resetear estilo botón

             if (!travelData.memories || !travelData.memories.photos || travelData.memories.photos.length === 0) {
                 el.noPhotosMessage.classList.remove('hidden');
                 el.toggleSelectModeBtn.classList.add('hidden'); // Ocultar botón si no hay fotos
                 el.collageCreationArea.classList.add('hidden');
                 return;
             }

             el.noPhotosMessage.classList.add('hidden');
             el.toggleSelectModeBtn.classList.remove('hidden');
             el.collageCreationArea.classList.remove('hidden');

             travelData.memories.photos.forEach(photo => {
                 const photoDiv = photoTemplate.content.firstElementChild.cloneNode(true);
                 photoDiv.dataset.photoId = photo.id; // Usar el ID del objeto photo
                 const img = photoDiv.querySelector('img');
                 img.src = photo.src;
                 img.alt = photo.name || 'Foto de viaje';
                 el.photoGallery.appendChild(photoDiv);
             });
             updateCollageButtonState(); // Actualizar contador (será 0)
         }

        function updateSavedCollages() {
            el.collageGallery.innerHTML = '';
            if (!travelData.memories || !travelData.memories.collages || travelData.memories.collages.length === 0) {
                el.noCollagesMessage.classList.remove('hidden');
                return;
            }
            el.noCollagesMessage.classList.add('hidden');
            travelData.memories.collages.forEach(collage => {
                 const collageDiv = savedCollageTemplate.content.firstElementChild.cloneNode(true);
                 collageDiv.dataset.collageId = collage.id;
                 collageDiv.querySelector('img').src = collage.data;
                 collageDiv.querySelector('.collage-date').textContent = formatDisplayDate(collage.date);
                 el.collageGallery.appendChild(collageDiv);
            });
        }


        function updateTripSummary() {
             console.log("Actualizando Resumen...");
            // Detalles Clave
            const hasDetails = travelData.personalInfo.firstName || travelData.tripDetails.destination;
            if (hasDetails) {
                 let duration = 'N/A';
                 if (travelData.tripDetails.startDate && travelData.tripDetails.endDate) {
                     try {
                        const start = new Date(travelData.tripDetails.startDate + 'T00:00:00');
                        const end = new Date(travelData.tripDetails.endDate + 'T00:00:00');
                        const diffTime = Math.abs(end - start);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 para incluir ambos días
                        duration = `${diffDays} día(s)`;
                     } catch { duration = 'Error fecha'; }
                 }
                 el.tripSummaryDetails.innerHTML = `
                    ${travelData.personalInfo.firstName || travelData.personalInfo.lastName ? `<p><strong>Viajero:</strong> ${travelData.personalInfo.firstName || ''} ${travelData.personalInfo.lastName || ''}</p>` : ''}
                    ${travelData.tripDetails.destination ? `<p><strong>Destino:</strong> ${travelData.tripDetails.destination || ''}</p>` : ''}
                    ${travelData.tripDetails.startDate ? `<p><strong>Fechas:</strong> ${formatDisplayDate(travelData.tripDetails.startDate)} - ${formatDisplayDate(travelData.tripDetails.endDate)}</p>` : ''}
                    ${travelData.tripDetails.transportType ? `<p><strong>Transporte:</strong> ${getTransportName(travelData.tripDetails.transportType) || ''}</p>` : ''}
                `;
                 el.summaryDuration.textContent = duration;
            } else {
                el.tripSummaryDetails.innerHTML = `<p class="text-gray-500">Completa la sección de Planificación.</p>`;
                el.summaryDuration.textContent = 'N/A';
            }

             // Estadísticas Rápidas
             const totalActivities = travelData.activities.length;
             const completedActivities = travelData.activities.filter(a => a.completed).length;
             el.summaryActivitiesCompleted.textContent = `${completedActivities} / ${totalActivities}`;
             el.summaryPhotosCount.textContent = travelData.memories.photos?.length || 0;
             el.summaryCollagesCount.textContent = travelData.memories.collages?.length || 0;


            // Resumen Financiero
            const budget = travelData.budget || {};
            const fixedBudget = (parseFloat(budget.ticketCost) || 0) + (parseFloat(budget.accommodationCost) || 0) + (parseFloat(budget.visaCost) || 0) + (parseFloat(budget.activitiesBudget) || 0);
            const variableExpensesTotal = travelData.expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const dailyExpensesTotal = Object.values(travelData.dailyExpenses || {}).flat().reduce((sum, exp) => sum + exp.amount, 0);
            const grandTotal = fixedBudget + variableExpensesTotal + dailyExpensesTotal; // Incluir presupuesto fijo en el total

            el.summaryTotalBudget.textContent = formatCurrency(fixedBudget);
            el.summaryVariableExpenses.textContent = formatCurrency(variableExpensesTotal);
            el.summaryDailyExpenses.textContent = formatCurrency(dailyExpensesTotal);
            el.summaryGrandTotal.textContent = formatCurrency(grandTotal);

            updateSummaryChart(fixedBudget, variableExpensesTotal, dailyExpensesTotal);
        }

         function updateSummaryChart(fixed, variable, daily) {
             if (!el.summaryChartCtx) {
                 console.warn("Contexto del gráfico de resumen no encontrado.");
                 return;
             }

             const labels = [];
             const data = [];
             const backgroundColors = [];

             // Usar el presupuesto fijo *estimado* como una categoría
             if (fixed > 0) { labels.push('Presup. Fijo'); data.push(fixed); backgroundColors.push('#60A5FA'); } // blue-400
             if (variable > 0) { labels.push('Gasto Pre-Viaje'); data.push(variable); backgroundColors.push('#FBBF24'); } // amber-400
             if (daily > 0) { labels.push('Gasto Diario'); data.push(daily); backgroundColors.push('#34D399'); } // emerald-400

             summaryChartPlaceholder.classList.toggle('hidden', labels.length > 0);
             el.summaryChartCtx.canvas.classList.toggle('hidden', labels.length === 0);


             if (summaryChart) summaryChart.destroy();
             if (labels.length === 0) {
                 summaryChart = null;
                 return;
             }

             summaryChart = new Chart(el.summaryChartCtx, {
                 type: 'doughnut', // Cambiado a doughnut
                 data: {
                     labels: labels,
                     datasets: [{ data: data, backgroundColor: backgroundColors, borderColor: '#ffffff', borderWidth: 2 }]
                 },
                 options: {
                     responsive: true, maintainAspectRatio: false,
                     plugins: {
                         legend: { position: 'bottom', labels: { padding: 15, boxWidth: 12, font: { size: 10 } } },
                         tooltip: { callbacks: { label: ctx => `${ctx.label}: ${formatCurrency(ctx.raw)}` } }
                     }
                 }
             });
         }

        function updateNotificationCount() {
             const unreadCount = travelData.notifications.filter(n => !n.read).length;
             el.notificationCount.textContent = unreadCount;
             el.notificationCount.classList.toggle('hidden', unreadCount === 0);
             el.notificationBtn.classList.toggle('pulse', unreadCount > 0);
         }

        function updateNotificationList() {
            el.notificationList.innerHTML = '';
            if (travelData.notifications.length === 0) {
                el.notificationList.innerHTML = '<p class="text-gray-500 text-center py-4">No hay notificaciones.</p>';
                return;
            }
            travelData.notifications.forEach(n => {
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg border ${n.read ? 'bg-gray-50 border-gray-200 opacity-70' : 'bg-white border-blue-200 shadow-sm'}`;
                div.dataset.id = n.id;
                // ... (icon logic como antes) ...
                let iconClass = 'fa-info-circle text-blue-500'; // Default
                 if (n.type === 'success') iconClass = 'fa-check-circle text-green-500';
                 else if (n.type === 'warning') iconClass = 'fa-exclamation-triangle text-yellow-500';
                 else if (n.type === 'error') iconClass = 'fa-times-circle text-red-500';
                 else if (n.type === 'reminder') iconClass = 'fa-bell text-purple-500';
                 else if (n.type === 'expense') iconClass = 'fa-dollar-sign text-teal-500';
                 else if (n.type === 'weather') iconClass = 'fa-cloud-sun text-cyan-500';

                div.innerHTML = `
                    <div class="flex items-start gap-3">
                        <i class="fas ${iconClass} text-xl mt-1 flex-shrink-0 w-5 text-center"></i>
                        <div class="flex-grow">
                            <h4 class="font-semibold ${n.read ? 'text-gray-600' : 'text-gray-800'}">${n.title}</h4>
                            <p class="text-sm ${n.read ? 'text-gray-500' : 'text-gray-600'}">${n.message}</p>
                            <p class="text-xs text-gray-400 mt-1">${timeAgo(n.date)}</p>
                        </div>
                        <button class="delete-notification-btn icon-btn-red text-xs" title="Eliminar"><i class="fas fa-times"></i></button>
                    </div>`;
                el.notificationList.appendChild(div);
            });
        }

        // --- Funciones Específicas (Weather, Reminders, Receipts) ---

        async function getWeather(city, dateStr) {
            if (!OPENWEATHER_API_KEY || OPENWEATHER_API_KEY === 'YOUR_OPENWEATHER_API_KEY' || !city || !dateStr) {
                weatherPreview.classList.add('hidden');
                return;
            }
            console.log(`Obteniendo tiempo para ${city} en fecha ${dateStr}`);
             // OpenWeather 5 day / 3 hour forecast API
             const url = `https://api.openweathermap.org/data/2.5/forecast?q=${encodeURIComponent(city)}&appid=${OPENWEATHER_API_KEY}&units=metric&lang=es`;

             try {
                 const response = await fetch(url);
                 if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                 const data = await response.json();
                 console.log("Weather Data:", data);

                 const targetDate = new Date(dateStr + 'T12:00:00'); // Mediodía de la fecha de inicio
                 let forecast = null;

                 // Encontrar la previsión más cercana a mediodía del día de inicio
                 if (data.list && data.list.length > 0) {
                     forecast = data.list.reduce((prev, curr) => {
                         const prevDate = new Date(prev.dt * 1000);
                         const currDate = new Date(curr.dt * 1000);
                         return Math.abs(currDate - targetDate) < Math.abs(prevDate - targetDate) ? curr : prev;
                     });
                 }


                 if (forecast) {
                     const temp = Math.round(forecast.main.temp);
                     const description = forecast.weather[0].description;
                     const iconCode = forecast.weather[0].icon;
                     const weatherDate = new Date(forecast.dt * 1000);

                     weatherTemp.textContent = `${temp}°C`;
                     weatherDesc.textContent = description;
                     // Mapear código de icono OpenWeather a FontAwesome (simplificado)
                     weatherIcon.className = `fas text-xl ${getWeatherIconClass(iconCode)}`;
                     weatherPreview.title = `Previsión para ${city} el ${weatherDate.toLocaleDateString()}`;
                     weatherPreview.classList.remove('hidden');
                 } else {
                      console.log("No se encontró previsión para la fecha específica.");
                     weatherPreview.classList.add('hidden');
                 }

             } catch (error) {
                 console.error("Error fetching weather:", error);
                 showToast("No se pudo obtener la previsión del tiempo.", 'warning');
                 weatherPreview.classList.add('hidden');
             }
         }

         function getWeatherIconClass(iconCode) {
             const map = {
                 '01d': 'fa-sun text-yellow-500', '01n': 'fa-moon text-indigo-400',
                 '02d': 'fa-cloud-sun text-yellow-400', '02n': 'fa-cloud-moon text-indigo-300',
                 '03d': 'fa-cloud text-gray-400', '03n': 'fa-cloud text-gray-400',
                 '04d': 'fa-cloud-meatball text-gray-500', '04n': 'fa-cloud-meatball text-gray-500', // Broken clouds approximation
                 '09d': 'fa-cloud-showers-heavy text-blue-500', '09n': 'fa-cloud-showers-heavy text-blue-400',
                 '10d': 'fa-cloud-sun-rain text-blue-400', '10n': 'fa-cloud-moon-rain text-blue-300',
                 '11d': 'fa-poo-storm text-yellow-600', '11n': 'fa-poo-storm text-yellow-500', // Tormenta
                 '13d': 'fa-snowflake text-cyan-400', '13n': 'fa-snowflake text-cyan-300',
                 '50d': 'fa-smog text-gray-400', '50n': 'fa-smog text-gray-400', // Niebla
             };
             return map[iconCode] || 'fa-question-circle text-gray-400'; // Default
         }


        function createDocumentReminders(documents) {
             const startDateStr = travelData.tripDetails.startDate;
             if (!startDateStr || documents.length === 0) return;
             try {
                 const startDate = new Date(startDateStr + 'T00:00:00');
                 const now = new Date();
                 now.setHours(0, 0, 0, 0); // Comparar solo fechas

                 // Crear recordatorios para 1 semana y 1 día antes (si son futuros)
                 const reminderDates = [
                     { days: 7, date: new Date(startDate).setDate(startDate.getDate() - 7) },
                     { days: 1, date: new Date(startDate).setDate(startDate.getDate() - 1) }
                 ];

                 reminderDates.forEach(rem => {
                     const reminderDate = new Date(rem.date);
                     if (reminderDate >= now) { // Solo futuros
                         documents.forEach(doc => {
                            // Evitar duplicados exactos (mismo doc, mismos días antes)
                             const exists = travelData.notifications.some(n =>
                                 n.type === 'reminder' && n.message.includes(doc) && n.message.includes(`${rem.days} día`)
                             );
                             if (!exists) {
                                 addNotification(
                                     `Recordatorio: ${doc}`,
                                     `Revisa/Prepara tu ${doc}. Viaje en ${rem.days} día(s) (${formatDisplayDate(startDateStr)})`,
                                     'reminder'
                                     // NOTA: La notificación aparece inmediatamente en la lista.
                                     // La ejecución real en la fecha/hora requeriría Notifications API o backend.
                                 );
                             }
                         });
                     }
                 });
                 // Guardar los cambios en las notificaciones (si addNotification no lo hace ya)
                 // saveData();

             } catch (error) { console.error("Error creando recordatorios:", error); }
         }

        function handleReceiptUpload(file, targetExpenseId, expenseType) {
            if (!file || !targetExpenseId) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const receiptDataUrl = event.target.result;
                let updated = false;
                if (expenseType === 'expense') {
                    const expense = travelData.expenses.find(exp => exp.id === targetExpenseId);
                    if (expense) { expense.receipt = receiptDataUrl; updated = true; updateExpensesUI(); }
                } else if (expenseType === 'daily') {
                    Object.keys(travelData.dailyExpenses).forEach(dateKey => {
                        const expense = travelData.dailyExpenses[dateKey].find(exp => exp.id === targetExpenseId);
                        if (expense) { expense.receipt = receiptDataUrl; updated = true; }
                    });
                    updateDailyExpensesUI();
                }
                if (updated) { saveData(); showToast('Recibo adjuntado.', 'success'); }
                else { showToast('Error: Gasto no encontrado.', 'error'); }
            };
             reader.onerror = () => { showToast("Error al leer archivo.", 'error'); };
            reader.readAsDataURL(file);
        }

        function showReceipt(expenseId, expenseType) {
            let receiptSrc = null;
            if (expenseType === 'expense') {
                receiptSrc = travelData.expenses.find(exp => exp.id === expenseId)?.receipt;
            } else if (expenseType === 'daily') {
                 Object.values(travelData.dailyExpenses || {}).flat().forEach(exp => {
                     if(exp.id === expenseId) receiptSrc = exp.receipt;
                 });
            }
            if (receiptSrc) {
                 showImageModal(receiptSrc, "Recibo Adjunto");
            } else {
                showToast('No se encontró recibo.', 'info');
            }
        }

         // Función genérica para mostrar imágenes en el modal de recibo/imagen
         function showImageModal(src, title = "Imagen") {
             el.modalReceiptImage.src = src;
             el.receiptModal.querySelector('h3').textContent = title; // Asignar título al modal
             el.receiptModal.classList.remove('hidden');
         }

        // --- Funciones de Utilidad ---
        function formatCurrency(amount) { /* ... como antes ... */
            const num = parseFloat(amount);
             if (isNaN(num)) return '$0.00';
             return `$${num.toFixed(2)}`;
        }
        function formatTime(timeString) { /* ... como antes ... */
            if (!timeString) return '';
             const [hours, minutes] = timeString.split(':');
             const hourNum = parseInt(hours);
             const ampm = hourNum >= 12 ? 'PM' : 'AM';
             const displayHour = hourNum % 12 || 12;
             return `${displayHour}:${minutes} ${ampm}`;
        }
        function formatDisplayDate(dateString) { /* ... como antes ... */
            if (!dateString) return 'N/A';
             try {
                 const date = new Date(dateString + 'T00:00:00');
                 return date.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
             } catch (e) { return dateString; }
        }
        function getCategoryName(key) { /* ... como antes ... */
             const names = { food: 'Comida', transport: 'Transporte', activities: 'Actividades', shopping: 'Compras', accommodation: 'Alojamiento', other: 'Otros' };
             return names[key] || key;
        }
        function getCategoryBadge(key) { /* ... como antes ... */
             const badges = { food: 'bg-red-100 text-red-800', transport: 'bg-blue-100 text-blue-800', activities: 'bg-green-100 text-green-800', shopping: 'bg-yellow-100 text-yellow-800', accommodation: 'bg-purple-100 text-purple-800', other: 'bg-gray-100 text-gray-800' };
             return badges[key] || 'bg-gray-100 text-gray-800';
        }
        function getTransportName(key) { /* ... como antes ... */
            const names = { airplane: 'Avión', train: 'Tren', ship: 'Barco', bus: 'Autobús', car: 'Automóvil', other: 'Otro' };
             return names[key] || key;
        }
        function timeAgo(isoDateString) { /* ... como antes ... */
            const date = new Date(isoDateString); const now = new Date(); const seconds = Math.round((now - date) / 1000); const minutes = Math.round(seconds / 60); const hours = Math.round(minutes / 60); const days = Math.round(hours / 24); if (seconds < 60) return `hace segs`; if (minutes < 60) return `hace ${minutes} min`; if (hours < 24) return `hace ${hours} h`; if (days < 30) return `hace ${days} días`; return date.toLocaleDateString('es-ES', { day:'numeric', month:'short' }); // Más de 30 días, mostrar fecha corta
        }

         // --- CSS Clases Comunes (para simplificar Tailwind en JS) ---
         // Definir clases comunes aquí para reutilizar
         const commonStyles = {
             inputField: 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm',
             btn: 'px-4 py-2 rounded-md font-medium transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2',
             btnBlue: 'bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500',
             btnGreen: 'bg-green-600 text-white hover:bg-green-700 focus:ring-green-500',
             btnRed: 'bg-red-600 text-white hover:bg-red-700 focus:ring-red-500',
             btnPurple: 'bg-purple-600 text-white hover:bg-purple-700 focus:ring-purple-500',
             btnTeal: 'bg-teal-500 text-white hover:bg-teal-600 focus:ring-teal-500',
             btnOrange: 'bg-orange-500 text-white hover:bg-orange-600 focus:ring-orange-500',
             btnOutlineBlue: 'border border-blue-600 text-blue-600 hover:bg-blue-50 focus:ring-blue-500',
             // ... añadir más según sea necesario ...
             thTable: 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider',
             tdTable: 'px-4 py-3 whitespace-nowrap text-sm text-gray-800',
             iconBtnBlue: 'text-blue-500 hover:text-blue-700 p-1 disabled:opacity-50',
             iconBtnRed: 'text-red-500 hover:text-red-700 p-1 disabled:opacity-50',
             badge: 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full',
             modalOverlay: 'fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4',
             modalContent: 'bg-white rounded-xl shadow-xl w-full overflow-hidden max-h-[90vh] flex flex-col',
             modalHeader: 'p-4 sm:p-6 border-b flex justify-between items-center flex-shrink-0',
             modalBody: 'p-4 sm:p-6 overflow-y-auto flex-grow',
             modalFooter: 'p-4 sm:p-6 border-t flex justify-end gap-3 flex-shrink-0',
         };
         // Aplicar clases comunes dinámicamente o usar @apply en <style> si prefieres
         document.querySelectorAll('.input-field').forEach(el => el.classList.add(...commonStyles.inputField.split(' ')));
         document.querySelectorAll('.btn.btn-blue').forEach(el => el.classList.add(...commonStyles.btn.split(' '), ...commonStyles.btnBlue.split(' ')));
         // ... aplicar otras clases comunes ...

    </script>
</body>
</html>